jQuery(document).ready(function($){if("undefined"==typeof wc_cp_product_data)return!1;$.blockUI.defaults.overlayCSS.cursor="default",Number.prototype.formatMoney=function(a,b,c){var d=this,a=isNaN(a=Math.abs(a))?2:a,b=void 0==b?".":b,c=void 0==c?",":c,e=d<0?"-":"",f=parseInt(d=Math.abs(+d||0).toFixed(a))+"",g=(g=f.length)>3?g%3:0;return e+(g?f.substr(0,g)+c:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+c)+(a?b+Math.abs(d-f).toFixed(a).slice(2):"")};var form=$(".js-composite-product-form"),bindings=$(".js-composite-product-bind"),Option=Backbone.Model.extend({initialize:function(){this.set("starting_price",this.get("price")),this.set("starting_price_incl_tax",this.get("price_incl_tax")),this.on("change:is_recommended",this.set_display),this.on("change:available",this.deselect),this.set_display()},defaults:{id:null,title:"",display:"",price:0,starting_price:0,price_incl_tax:0,starting_price_incl_tax:0,formatted_price:"",formula:"{p}",weight:0,sku:"",is_recommended:0,available:!1,scenarios:[],selected:0,actual_selected:0},set_formatted_price:function(){this.set("formatted_price",this.get("price")>0?"+"+wc_cp_params.currency+parseFloat(this.get("price")).formatMoney():"")},set_display:function(){this.set_formatted_price(),this.set("display",this.get("title")+(this.get("formatted_price")?" <strong>["+this.get("formatted_price")+"]</strong>":"")+(this.get("is_recommended")?" <em>Recommended</em>":""))},select:function(){this.get("actual_selected")!=this.get("id")?(this.set("selected",this.get("id")),this.set("actual_selected",this.get("id"))):(this.set("selected",0),this.set("actual_selected",0))},deselect:function(){this.get("available")||(this.set("selected",0),this.set("actual_selected",0))},calculate_price:function(a){this.set("price",this.get_calculated_price(this.get("starting_price"),a)),this.set("price_incl_tax",this.get_calculated_price(this.get("starting_price_incl_tax"),a)),this.set_display()},get_calculated_price:function(price,components){var formula=this.get("formula").replace("{p}",price);if(formula.indexOf("{n")>-1){var i=0;components.each(function(a){var b=a.get("selections");if(i++,formula=formula.replace("{n"+i+"}",b instanceof PriceFormulas?b.at(0).get("value"):0),formula.indexOf("{n")==-1)return!1})}return eval(formula)}}),Options=Backbone.Collection.extend({model:Option}),PriceFormula=Backbone.Model.extend({initialize:function(){this.calculate_price()},defaults:{title:"",value:0,formula:"",error:!1,price:0,price_incl_tax:0},calculate_price:function(){this.set("price",this.get_price()),this.set("price_incl_tax",this.get_price(!0))},get_price:function(incl_tax){var price=eval(this.get("formula").replace("{n}",this.get("value"))),tax_rate=1.2;return incl_tax?price*tax_rate:price}}),PriceFormulas=Backbone.Collection.extend({model:PriceFormula}),Component=Backbone.Model.extend({initialize:function(a){if(this.set("empty_text",this.get("empty_text")+(this.get("optional")?" (optional)":" (required)")),this.set("options",new Options(this.get("options"))),this.on("change:selections",this.maybe_show_tag_number_field),this.on("change:selections",this.update_selected),this.is_style("number")?(this.on("change:price_value",this.update_value_selections),this.set("price_value",this.get("default_value"))):(this.set("selections",new Options(this.get("selections"))),this.listenTo(this.get("options"),"change:selected",this.update_option_selections)),this.get("default_id")>0){var b=this.get("options").get(this.get("default_id"));b instanceof Option&&b.set("selected",b.get("id"))}if(this.get("recommended_id")>0){var b=this.get("options").get(this.get("recommended_id"));b instanceof Option&&b.set("is_recommended",1)}},defaults:{id:null,name:"",title:"",style:"dropdown",options:[],selections:[],no_of_selections:0,selected:0,first:0,optional:!1,error:!1,display_error:!1,sku_order:0,sku_default:"",affect_sku:!1,empty_text:"None",use_tag_numbers:!1,show_tag_number_field:!1,tag_number:"",recommended_id:0,default_id:0,default_value:"",price_value:"",step_value:.01,min_value:0,max_value:"",suffix:"",updating:!1,sovereign:!1,price_formula:"",available:!0},is_style:function(a){return this.get("style")==a},update_value_selections:function(){var a=this.get("title")+": "+this.get("price_value").toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+this.get("suffix"),b=Math.max(this.get("price_value"),this.get("min_value")),c=this.get("max_value")?Math.min(b,this.get("max_value")):b,d=c!=this.get("price_value"),e=[{title:a,value:c,error:d,formula:this.get("price_formula")}];this.set("selections",new PriceFormulas(e)),this.set("no_of_selections",e.length)},select:function(a){if($(a.target).val()){var b=this.get("options").get($(a.target).val());b?(b.set("selected",b.get("id")),this.set("first",b.get("id"))):this.deselect()}else this.deselect()},deselect:function(){this.get("options").each(function(a){a.set("selected",0),a.set("actual_selected",0)})},update_option_selections:function(a){if(!this.get("updating")){this.set("updating",!0);var b=this,c=new Options;b.get("options").each(function(d){d.get("selected")&&(b.is_style("checkboxes")?a instanceof Option&&d.get("id")!=a.get("id")&&c.push(d):a instanceof Option&&(d.get("id")!=a.get("id")?d.set("selected",0):c.push(d)))}),b.get("options").at(0)&&this.set("first",b.get("options").at(0).get("id")),a instanceof Option&&a.get("selected")&&c.push(a),this.set("selections",c),this.set("no_of_selections",c.length),this.set("updating",!1)}},update_selected:function(){var a=this.get("selections");if(a.length)if(a instanceof Options)this.set("selected",a.at(0).get("id"));else{var b=a.at(0);this.set("selected",!(!b.get("value")||b.get("error")))}else this.set("selected",0)},maybe_show_tag_number_field:function(){var a=this.get("selections");this.get("use_tag_numbers")&&a.length&&this.set("show_tag_number_field",!0)},close:function(a,b){a.preventDefault(),$(b).closest(".component").toggleClass("closed").find(".component_inner").slideToggle()}}),Components=Backbone.Collection.extend({model:Component}),Scenario=Backbone.Model.extend({defaults:{id:null,actions:[],masked_components:[]}}),Scenarios=Backbone.Collection.extend({model:Scenario}),Product=Backbone.Model.extend({initialize:function(){this.set("components",new Components(this.get("components"))),this.set("scenarios",new Scenarios(this.get("scenarios"))),this.listenTo(this.get("components"),"change:selections",this.evaluate),this.evaluate()},defaults:{id:null,sku:"",weight:0,components:[],scenarios:[],min_price:0,min_price_incl_tax:0,base_price:0,base_weight:0,base_sku:"",build_sku:!1,price:0,price_incl_tax:0,weight:0,quantity:1,errors:0,selections:0,adding_to_cart:!1},evaluate:function(){form.block({message:null,overlayCSS:{opacity:.6}});var a=this,b=a.get("components"),c=parseFloat(this.get("min_price")),d=parseFloat(this.get("min_price_incl_tax")),e=parseFloat(this.get("base_price")),f=parseFloat(this.get("base_price_incl_tax")),g=parseFloat(this.get("base_weight")),h=[this.get("base_sku")],i=0,j=0,k=[];b.each(function(c){var d=c.get("options"),l=c.get("selections");d.length&&d.each(function(a){a.calculate_price(b)}),l.length?l.each(function(b){if(b instanceof Option){if(e+=parseFloat(b.get("price")?b.get("price"):0),f+=parseFloat(b.get("price_incl_tax")?b.get("price_incl_tax"):0),g+=parseFloat(b.get("weight")),a.get("build_sku")&&c.get("affect_sku")&&(h[c.get("sku_order")]=b.get("sku")),k.length)for(var d=0;d<k.length;d++)0>$.inArray(k[d],b.get("scenarios"))&&(k.splice(d,1),d--);else $.extend(k,b.get("scenarios"));j++,c.set("error",!1)}else b instanceof PriceFormula&&(e+=parseFloat(b.get("price")?b.get("price"):0),f+=parseFloat(b.get("price_incl_tax")?b.get("price_incl_tax"):0),c.set("error",b.get("error")),c.get("error")?i++:j++)}):(a.get("build_sku")&&c.get("affect_sku")&&(h[c.get("sku_order")]=c.get("sku_default")),c.get("optional")||(i++,c.set("error",!0)))}),k=k.length?$.unique(k):a.get("scenarios").pluck("id"),a.get("components").each(function(a){a.get("options").each(function(b){if(k.length&&!a.get("sovereign")){var c=!1;b.get("scenarios").length&&$.each(b.get("scenarios"),function(a,b){if($.inArray(b,k)>-1)return c=!0,!0}),c?b.set("available",!0):b.set("available",!1)}else b.set("available",!0)})}),this.set("price",Math.max(e,c).formatMoney()),this.set("price_incl_tax",Math.max(f,d).formatMoney()),this.set("weight",g.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")),this.set("errors",i),this.set("selections",j),this.set("sku",h.join("")),form.unblock()},get_selections:function(){var a={};return this.get("components").each(function(b){var c=b.get("selections");a[b.get("id")]=[],c?c.each(function(c){a[b.get("id")].push({title:b.get("title"),selected:c.get("title")+(b.get("tag_number")?" <em>Tag Number: "+b.get("tag_number")+"</em>":"")})}):a[b.get("id")].push({title:b.get("title"),selected:b.get("empty_text")})}),a},add_to_cart_click:function(a){a.preventDefault(),form.trigger("submit")},add_to_cart:function(a){if(!product.get("adding_to_cart")&&!product.get("errors")){product.set("adding_to_cart",!0),a.preventDefault();var b=wc_add_to_cart_params.wc_ajax_url.toString().replace("%%endpoint%%","add_to_cart"),c={product_id:product.get("id"),product_sku:product.get("sku"),quantity:parseInt(product.get("quantity")),product_price:parseFloat(product.get("price").replace(",","")),product_weight_clean:parseFloat(product.get("weight")),product_weight:product.get("weight")+wc_cp_product_data.weight_unit,selections:product.get_selections()},d=$(".composite_add_to_cart_button").eq(0);form.block({message:null,overlayCSS:{opacity:.6}}),$(document.body).trigger("adding_to_cart",[d,c]),$.post(b,c,function(a){if(a){var b=window.location.toString();if(b=b.replace("add-to-cart","added-to-cart"),a.error&&a.product_url)return void(window.location=a.product_url);if("yes"===wc_add_to_cart_params.cart_redirect_after_add)return void(window.location=wc_add_to_cart_params.cart_url);var c=a.fragments,e=a.cart_hash;c&&$.each(c,function(a){$(a).addClass("updating")}),c&&$.each(c,function(a,b){$(a).replaceWith(b)}),$(document.body).trigger("added_to_cart",[c,e,d])}},"json").always(function(a){console.log(a),form.unblock(),product.set("adding_to_cart",!1)})}}}),product=new Product(wc_cp_product_data);form.on("valid.fndtn.abide",product.add_to_cart),rivets.formatters["="]=function(a,b){return a==b},rivets.formatters["!="]=function(a,b){return a!=b},rivets.formatters["!"]=function(a){return!a},rivets.formatters[">"]=function(a,b){return parseFloat(a)>parseFloat(b)},rivets.formatters[">="]=function(a,b){return parseFloat(a)>=parseFloat(b)},rivets.formatters["<"]=function(a,b){return parseFloat(a)<parseFloat(b)},rivets.formatters["<="]=function(a,b){return parseFloat(a)<=parseFloat(b)},rivets.formatters["&&"]=function(a,b){return a&&b},rivets.formatters["^"]=function(a,b){return a||b},rivets.formatters.append=function(a,b){return a+b},rivets.configure({handler:function(a,b,c){this.call(c.model,b,a)}}),rivets.bind(bindings,{product:product})});