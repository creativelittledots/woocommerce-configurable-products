jQuery(document).ready(function($){if("undefined"==typeof wc_cp_product_data)return!1;$.blockUI.defaults.overlayCSS.cursor="default",Number.prototype.formatMoney=function(a,b,c){var d=this,a=isNaN(a=Math.abs(a))?2:a,b=void 0==b?".":b,c=void 0==c?",":c,e=d<0?"-":"",f=parseInt(d=Math.abs(+d||0).toFixed(a))+"",g=(g=f.length)>3?g%3:0;return e+(g?f.substr(0,g)+c:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+c)+(a?b+Math.abs(d-f).toFixed(a).slice(2):"")};var form=$(".js-composite-product-form"),bindings=$(".js-composite-product-bind"),Option=Backbone.Model.extend({initialize:function(){this.on("change:is_recommended",this.display),this.on("change:available",this.deselect),this.set("formatted_price",this.get("price")>0?wc_cp_params.currency+parseFloat(this.get("price")).formatMoney():""),this.display()},defaults:{id:null,title:"",display:"",price:0,price_incl_tax:0,formatted_price:"",weight:0,sku:"",is_recommended:0,available:!1,scenarios:[],selected:0,actual_selected:0},display:function(){this.set("display",this.get("title")+(this.get("formatted_price")?" <strong>[+"+this.get("formatted_price")+"]</strong>":"")+(this.get("is_recommended")?" <em>Recommended</em>":""))},select:function(){this.get("actual_selected")!=this.get("id")?(this.set("selected",this.get("id")),this.set("actual_selected",this.get("id"))):(this.set("selected",0),this.set("actual_selected",0))},deselect:function(){this.get("available")||(this.set("selected",0),this.set("actual_selected",0))}}),Options=Backbone.Collection.extend({model:Option}),PriceFormula=Backbone.Model.extend({initialize:function(){this.calculate_price(),this.set_title()},defaults:{title:"",value:0,formula:"",price:0,price_incl_tax:0},calculate_price:function(){this.set("price",this.get_price()),this.set("price_incl_tax",this.get_price(!0))},get_price:function(incl_tax){var price=eval(this.get("formula").replace("{n}",this.get("value"))),tax_rate=1.2;return incl_tax?price*tax_rate:price},set_title:function(){this.set("title",this.get("value"))}}),PriceFormulas=Backbone.Collection.extend({model:PriceFormula}),Component=Backbone.Model.extend({initialize:function(a){if(this.set("empty_text",this.get("empty_text")+(this.get("optional")?" (optional)":" (required)")),this.set("price_value",this.get("default_value")),this.set("options",new Options(this.get("options"))),this.is_style("number")?this.calculate():this.set("selections",new Options(this.get("selections"))),this.listenTo(this.get("options"),"change:selected",this.update_selections),this.on("change:selections",this.maybe_show_tag_number_field),this.on("change:selections",this.update_selected),this.on("change:price_value",this.calculate),this.get("default_id")>0){var b=this.get("options").get(this.get("default_id"));b instanceof Option&&b.set("selected",b.get("id"))}if(this.get("recommended_id")>0){var b=this.get("options").get(this.get("recommended_id"));b instanceof Option&&b.set("is_recommended",1)}this.update_selected(),this.maybe_show_tag_number_field()},defaults:{id:null,name:"",title:"",style:"dropdown",options:[],selections:[],no_of_selections:0,selected:0,first:0,optional:!0,error:!1,sku_order:0,sku_default:"",affect_sku:!1,empty_text:"None",use_tag_numbers:!1,show_tag_number_field:!1,tag_number:"",recommended_id:0,default_id:0,default_value:"",price_value:"",step_value:.01,min_value:0,max_value:"",updating:!1,sovereign:!1,price_formula:"",available:!0},is_style:function(a){return this.get("style")==a},calculate:function(){if(this.get("price_value")){var a=[{value:this.get("price_value"),formula:this.get("price_formula")}];this.set("selections",new PriceFormulas(a))}},select:function(a){if($(a.target).val()){var b=this.get("options").get($(a.target).val());b?(b.set("selected",b.get("id")),this.set("first",b.get("id"))):this.deselect()}else this.deselect()},deselect:function(){this.get("options").each(function(a){a.set("selected",0),a.set("actual_selected",0)})},update_selections:function(a){if(!this.get("updating")){this.set("updating",!0);var b=this,c=new Options;b.get("options").each(function(d){d.get("selected")&&(b.is_style("checkboxes")?a instanceof Option&&d.get("id")!=a.get("id")&&c.push(d):a instanceof Option&&(d.get("id")!=a.get("id")?d.set("selected",0):c.push(d)))}),b.get("options").at(0)&&this.set("first",b.get("options").at(0).get("id")),a instanceof Option&&a.get("selected")&&c.push(a),this.set("selections",c),this.set("no_of_selections",c.length),this.set("updating",!1)}},update_selected:function(){var a=this.get("selections");a.length?this.set("selected",a.at(0).get("id")):this.set("selected",0)},maybe_show_tag_number_field:function(){var a=this.get("selections");this.get("use_tag_numbers")&&a.length&&this.set("show_tag_number_field",!0)},close:function(a,b){a.preventDefault(),$(b).closest(".component").toggleClass("closed").find(".component_inner").slideToggle()}}),Components=Backbone.Collection.extend({model:Component}),Scenario=Backbone.Model.extend({defaults:{id:null,actions:[],masked_components:[]}}),Scenarios=Backbone.Collection.extend({model:Scenario}),Product=Backbone.Model.extend({initialize:function(){this.set("components",new Components(this.get("components"))),this.set("scenarios",new Scenarios(this.get("scenarios"))),this.listenTo(this.get("components"),"change:selections",this.evaluate),this.evaluate()},defaults:{id:null,sku:"",weight:0,components:[],scenarios:[],min_price:0,min_price_incl_tax:0,base_price:0,base_weight:0,base_sku:"",build_sku:!1,price:0,price_incl_tax:0,weight:0,quantity:1,errors:0,selections:0,adding_to_cart:!1},evaluate:function(){form.block({message:null,overlayCSS:{opacity:.6}});var a=this;min_price=parseFloat(this.get("min_price")),min_price_incl_tax=parseFloat(this.get("min_price_incl_tax")),price=parseFloat(this.get("base_price")),price_incl_tax=parseFloat(this.get("base_price_incl_tax")),weight=parseFloat(this.get("base_weight")),sku=[this.get("base_sku")],errors=0,no_of_selections=0,active_scenarios=[],a.get("components").each(function(b){var c=b.get("selections");c.length?c.each(function(c){c instanceof Option?(price+=parseFloat(c.get("price")),price_incl_tax+=parseFloat(c.get("price_incl_tax")),weight+=parseFloat(c.get("weight")),a.get("build_sku")&&b.get("affect_sku")&&(sku[b.get("sku_order")]=c.get("sku")),active_scenarios.length?$.each(active_scenarios,function(a,b){0>$.inArray(b,c.get("scenarios"))&&active_scenarios.splice(a,1)}):$.extend(active_scenarios,c.get("scenarios")),no_of_selections++,b.set("error",!1)):c instanceof PriceFormula&&(price+=parseFloat(c.get("price")),price_incl_tax+=parseFloat(c.get("price_incl_tax")),b.set("error",!1))}):(a.get("build_sku")&&b.get("affect_sku")&&(sku[b.get("sku_order")]=b.get("sku_default")),b.get("optional")||(errors++,b.set("error",!0)))}),active_scenarios=active_scenarios.length?$.unique(active_scenarios):a.get("scenarios").pluck("id"),a.get("components").each(function(a){a.get("options").each(function(b){if(active_scenarios.length&&!a.get("sovereign")){var c=!1;b.get("scenarios").length&&$.each(b.get("scenarios"),function(a,b){if($.inArray(b,active_scenarios)>-1)return c=!0,!0}),c?b.set("available",!0):b.set("available",!1)}else b.set("available",!0)})}),this.set("price",Math.max(price,min_price).formatMoney()),this.set("price_incl_tax",Math.max(price_incl_tax,min_price_incl_tax).formatMoney()),this.set("weight",weight.toFixed(1)),this.set("errors",errors),this.set("selections",no_of_selections),this.set("sku",sku.join("")),form.unblock()},get_selections:function(){var a={};return this.get("components").each(function(b){var c=b.get("selections");a[b.get("id")]=[],c?c.each(function(c){a[b.get("id")].push({title:b.get("title"),selected:c.get("title")+(b.get("tag_number")?" <em>Tag Number: "+b.get("tag_number")+"</em>":"")})}):a[b.get("id")].push({title:b.get("title"),selected:b.get("empty_text")})}),a},add_to_cart_click:function(a){a.preventDefault(),form.trigger("submit")},add_to_cart:function(a){if(!product.get("adding_to_cart")){product.set("adding_to_cart",!0),a.preventDefault();var b=wc_add_to_cart_params.wc_ajax_url.toString().replace("%%endpoint%%","add_to_cart"),c={product_id:product.get("id"),product_sku:product.get("sku"),quantity:parseInt(product.get("quantity")),product_price:parseFloat(product.get("price").replace(",","")),product_weight:parseFloat(product.get("weight").replace(",","")),selections:product.get_selections()},d=$(".composite_add_to_cart_button").eq(0);form.block({message:null,overlayCSS:{opacity:.6}}),$(document.body).trigger("adding_to_cart",[d,c]),$.post(b,c,function(a){if(a){var b=window.location.toString();if(b=b.replace("add-to-cart","added-to-cart"),a.error&&a.product_url)return void(window.location=a.product_url);if("yes"===wc_add_to_cart_params.cart_redirect_after_add)return void(window.location=wc_add_to_cart_params.cart_url);var c=a.fragments,e=a.cart_hash;c&&$.each(c,function(a){$(a).addClass("updating")}),c&&$.each(c,function(a,b){$(a).replaceWith(b)}),$(document.body).trigger("added_to_cart",[c,e,d])}},"json").always(function(a){console.log(a),form.unblock(),product.set("adding_to_cart",!1)})}}}),product=new Product(wc_cp_product_data);form.on("valid.fndtn.abide",product.add_to_cart),form.on("keypress",".js-cnfg-number-field",function(a){a.preventDefault()}),rivets.formatters["="]=function(a,b){return a==b},rivets.formatters["!="]=function(a,b){return a!=b},rivets.formatters["!"]=function(a){return!a},rivets.formatters[">"]=function(a,b){return a>b},rivets.formatters[">="]=function(a,b){return a>=b},rivets.formatters["<"]=function(a,b){return a<b},rivets.formatters["<="]=function(a,b){return a<=b},rivets.formatters.and=function(a,b){return a&&b},rivets.formatters.or=function(a,b){return a||b},rivets.formatters.append=function(a,b){return a+b},rivets.configure({handler:function(a,b,c){this.call(c.model,b,a)}}),rivets.bind(bindings,{product:product})});