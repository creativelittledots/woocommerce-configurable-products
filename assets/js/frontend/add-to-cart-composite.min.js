jQuery(document).ready(function(e){if("undefined"==typeof wc_cp_product_data)return!1;e.blockUI.defaults.overlayCSS.cursor="default",Number.prototype.formatMoney=function(e,t,i){var s=this,e=isNaN(e=Math.abs(e))?2:e,t=void 0==t?".":t,i=void 0==i?",":i,n=0>s?"-":"",o=parseInt(s=Math.abs(+s||0).toFixed(e))+"",a=(a=o.length)>3?a%3:0;return n+(a?o.substr(0,a)+i:"")+o.substr(a).replace(/(\d{3})(?=\d)/g,"$1"+i)+(e?t+Math.abs(s-o).toFixed(e).slice(2):"")};var t=e(".js-composite-product-form"),i=e(".js-composite-product-bind"),s=Backbone.Model.extend({initialize:function(){this.on("change:is_recommended",this.display),this.on("change:available",this.deselect),this.set("formatted_price",this.get("price")>0?wc_cp_params.currency+parseFloat(this.get("price")).formatMoney():""),this.display()},defaults:{id:null,title:"",display:"",price:0,price_incl_tax:0,formatted_price:"",weight:0,sku:"",is_recommended:0,available:!1,scenarios:[],selected:0},display:function(){this.set("display",this.get("title")+(this.get("formatted_price")?" <strong>[+"+this.get("formatted_price")+"]</strong>":"")+(this.get("is_recommended")?" <em>Recommended</em>":""))},select:function(){this.set("selected",this.get("id"))},deselect:function(){this.get("available")||this.set("selected",0)}}),n=Backbone.Collection.extend({model:s}),o=Backbone.Model.extend({initialize:function(e){if(this.set("empty_text",this.get("empty_text")+(this.get("optional")?" (optional)":" (required)")),this.set("options",new n(this.get("options"))),this.set("selections",new n(this.get("selections"))),this.listenTo(this.get("options"),"change:selected",this.update_selections),this.on("change:selections",this.maybe_show_tag_number_field),this.on("change:selections",this.update_selected),this.get("default_id")>0){var t=this.get("options").get(this.get("default_id"));t instanceof s&&t.set("selected",t.get("id"))}if(this.get("recommended_id")>0){var t=this.get("options").get(this.get("recommended_id"));t instanceof s&&t.set("is_recommended",1)}this.update_selected(),this.maybe_show_tag_number_field()},defaults:{id:null,name:"",title:"",style:"dropdown",options:[],selections:[],no_of_selections:0,selected:0,first:0,optional:!0,error:!1,sku_order:0,sku_default:"",affect_sku:!1,empty_text:"None",use_tag_numbers:!1,show_tag_number_field:!1,tag_number:"",recommended_id:0,default_id:0,updating:!1,sovereign:!1},is_style:function(e){return this.get("style")==e},select:function(t){if(e(t.target).val()){var i=this.get("options").get(e(t.target).val());i?(i.set("selected",i.get("id")),this.set("first",i.get("id"))):this.deselect()}else this.deselect()},deselect:function(){this.get("options").each(function(e){e.set("selected",0)})},update_selections:function(e){if(!this.get("updating")){this.set("updating",!0);var t=this,i=new n;t.get("options").each(function(n){n.get("selected")&&(t.is_style("checkboxes")?e instanceof s&&n.get("id")!=e.get("id")&&i.push(n):e instanceof s&&(n.get("id")!=e.get("id")?n.set("selected",0):i.push(n)))}),t.get("options").at(0)&&this.set("first",t.get("options").at(0).get("id")),e instanceof s&&e.get("selected")&&i.push(e),this.set("selections",i),this.set("no_of_selections",i.length),this.set("updating",!1)}},update_selected:function(){var e=this.get("selections");e.length?this.set("selected",e.at(0).get("id")):this.set("selected",0)},maybe_show_tag_number_field:function(){var e=this.get("selections");this.get("use_tag_numbers")&&e.length&&this.set("show_tag_number_field",!0)},close:function(t,i){t.preventDefault(),e(i).closest(".component").toggleClass("closed").find(".component_inner").slideToggle()}}),a=Backbone.Collection.extend({model:o}),c=Backbone.Model.extend({defaults:{id:null,actions:[],masked_components:[]}}),r=Backbone.Collection.extend({model:c}),d=Backbone.Model.extend({initialize:function(){this.set("components",new a(this.get("components"))),this.set("scenarios",new r(this.get("scenarios"))),this.listenTo(this.get("components"),"change:selections",this.evaluate),this.evaluate()},defaults:{id:null,sku:"",weight:0,components:[],scenarios:[],min_price:0,min_price_incl_tax:0,base_price:0,base_weight:0,base_sku:"",build_sku:!1,price:0,price_incl_tax:0,weight:0,quantity:1,errors:0,selections:0,adding_to_cart:!1},evaluate:function(){t.block({message:null,overlayCSS:{opacity:.6}});var i=this;min_price=parseFloat(this.get("min_price")),min_price_incl_tax=parseFloat(this.get("min_price_incl_tax")),price=parseFloat(this.get("base_price")),price_incl_tax=parseFloat(this.get("base_price_incl_tax")),weight=parseFloat(this.get("base_weight")),sku=[this.get("base_sku")],errors=0,no_of_selections=0,active_scenarios=[],i.get("components").each(function(t){var n=t.get("selections");n.length?n.each(function(n){n instanceof s&&(price+=parseFloat(n.get("price")),price_incl_tax+=parseFloat(n.get("price_incl_tax")),weight+=parseFloat(n.get("weight")),i.get("build_sku")&&t.get("affect_sku")&&(sku[t.get("sku_order")]=n.get("sku")),active_scenarios.length?e.each(active_scenarios,function(t,i){0>e.inArray(i,n.get("scenarios"))&&active_scenarios.splice(t,1)}):e.extend(active_scenarios,n.get("scenarios")),no_of_selections++,t.set("error",!1))}):(sku[t.get("sku_order")]=t.get("sku_default"),t.get("optional")||(errors++,t.set("error",!0)))}),active_scenarios=active_scenarios.length?e.unique(active_scenarios):i.get("scenarios").pluck("id"),i.get("components").each(function(t){t.get("options").each(function(i){if(active_scenarios.length&&!t.get("sovereign")){var s=!1;i.get("scenarios").length&&e.each(i.get("scenarios"),function(t,i){return e.inArray(i,active_scenarios)>-1?(s=!0,!0):void 0}),s?i.set("available",!0):i.set("available",!1)}else i.set("available",!0)})}),this.set("price",Math.max(price,min_price).formatMoney()),this.set("price_incl_tax",Math.max(price_incl_tax,min_price_incl_tax).formatMoney()),this.set("weight",weight.toFixed(1)),this.set("errors",errors),this.set("selections",no_of_selections),this.set("sku",sku.join("")),t.unblock()},get_selections:function(){var e={};return this.get("components").each(function(t){var i=t.get("selections");e[t.get("id")]=[],i?i.each(function(i){e[t.get("id")].push({title:t.get("title"),selected:i.get("title")+(t.get("tag_number")?" <em>Tag Number: "+t.get("tag_number")+"</em>":"")})}):e[t.get("id")].push({title:t.get("title"),selected:t.get("empty_text")})}),e},add_to_cart_click:function(e){e.preventDefault(),t.trigger("submit")},add_to_cart:function(i){if(!l.get("adding_to_cart")){l.set("adding_to_cart",!0),i.preventDefault();var s=wc_add_to_cart_params.wc_ajax_url.toString().replace("%%endpoint%%","add_to_cart"),n={product_id:l.get("id"),product_sku:l.get("sku"),quantity:l.get("quantity"),price:l.get("price"),weight:l.get("weight"),selections:l.get_selections()},o=e(".composite_add_to_cart_button").eq(0);t.block({message:null,overlayCSS:{opacity:.6}}),e(document.body).trigger("adding_to_cart",[o,n]),e.post(s,n,function(t){if(t){var i=window.location.toString();if(i=i.replace("add-to-cart","added-to-cart"),t.error&&t.product_url)return void(window.location=t.product_url);if("yes"===wc_add_to_cart_params.cart_redirect_after_add)return void(window.location=wc_add_to_cart_params.cart_url);var s=t.fragments,n=t.cart_hash;s&&e.each(s,function(t){e(t).addClass("updating")}),s&&e.each(s,function(t,i){e(t).replaceWith(i)}),e(document.body).trigger("added_to_cart",[s,n,o])}},"json").always(function(e){console.log(e),t.unblock(),l.set("adding_to_cart",!1)})}}}),l=new d(wc_cp_product_data);t.on("valid.fndtn.abide",l.add_to_cart),rivets.formatters["="]=function(e,t){return e==t},rivets.formatters["!="]=function(e,t){return e!=t},rivets.formatters["!"]=function(e){return!e},rivets.formatters[">"]=function(e,t){return e>t},rivets.formatters[">="]=function(e,t){return e>=t},rivets.formatters["<"]=function(e,t){return t>e},rivets.formatters["<="]=function(e,t){return t>=e},rivets.formatters.and=function(e,t){return e&&t},rivets.formatters.or=function(e,t){return e||t},rivets.formatters.append=function(e,t){return e+t},rivets.configure({handler:function(e,t,i){this.call(i.model,t,e)}}),rivets.bind(i,{product:l})});