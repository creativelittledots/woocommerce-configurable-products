jQuery(document).ready(function(a){if("undefined"==typeof wc_cp_product_data)return!1;a.blockUI.defaults.overlayCSS.cursor="default",Number.prototype.formatMoney=function(a,b,c){var d=this,a=isNaN(a=Math.abs(a))?2:a,b=void 0==b?".":b,c=void 0==c?",":c,e=d<0?"-":"",f=parseInt(d=Math.abs(+d||0).toFixed(a))+"",g=(g=f.length)>3?g%3:0;return e+(g?f.substr(0,g)+c:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+c)+(a?b+Math.abs(d-f).toFixed(a).slice(2):"")};var b=a(".js-composite-product-form"),c=a(".js-composite-product-bind"),d=Backbone.Model.extend({initialize:function(){this.on("change:is_recommended",this.display),this.on("change:available",this.deselect),this.set("formatted_price",this.get("price")>0?wc_cp_params.currency+parseFloat(this.get("price")).formatMoney():""),this.display()},defaults:{id:null,title:"",display:"",price:0,price_incl_tax:0,formatted_price:"",weight:0,sku:"",is_recommended:0,available:!1,scenarios:[],selected:0,actual_selected:0},display:function(){this.set("display",this.get("title")+(this.get("formatted_price")?" <strong>[+"+this.get("formatted_price")+"]</strong>":"")+(this.get("is_recommended")?" <em>Recommended</em>":""))},select:function(){this.get("actual_selected")!=this.get("id")?(this.set("selected",this.get("id")),this.set("actual_selected",this.get("id"))):(this.set("selected",0),this.set("actual_selected",0))},deselect:function(){this.get("available")||(this.set("selected",0),this.set("actual_selected",0))}}),e=Backbone.Collection.extend({model:d}),f=Backbone.Model.extend({initialize:function(a){if(this.set("empty_text",this.get("empty_text")+(this.get("optional")?" (optional)":" (required)")),this.set("options",new e(this.get("options"))),this.set("selections",new e(this.get("selections"))),this.listenTo(this.get("options"),"change:selected",this.update_selections),this.on("change:selections",this.maybe_show_tag_number_field),this.on("change:selections",this.update_selected),this.get("default_id")>0){var b=this.get("options").get(this.get("default_id"));b instanceof d&&b.set("selected",b.get("id"))}if(this.get("recommended_id")>0){var b=this.get("options").get(this.get("recommended_id"));b instanceof d&&b.set("is_recommended",1)}this.update_selected(),this.maybe_show_tag_number_field()},defaults:{id:null,name:"",title:"",style:"dropdown",options:[],selections:[],no_of_selections:0,selected:0,first:0,optional:!0,error:!1,sku_order:0,sku_default:"",affect_sku:!1,empty_text:"None",use_tag_numbers:!1,show_tag_number_field:!1,tag_number:"",recommended_id:0,default_id:0,updating:!1,sovereign:!1},is_style:function(a){return this.get("style")==a},select:function(b){if(a(b.target).val()){var c=this.get("options").get(a(b.target).val());c?(c.set("selected",c.get("id")),this.set("first",c.get("id"))):this.deselect()}else this.deselect()},deselect:function(){this.get("options").each(function(a){a.set("selected",0),a.set("actual_selected",0)})},update_selections:function(a){if(!this.get("updating")){this.set("updating",!0);var b=this,c=new e;b.get("options").each(function(e){e.get("selected")&&(b.is_style("checkboxes")?a instanceof d&&e.get("id")!=a.get("id")&&c.push(e):a instanceof d&&(e.get("id")!=a.get("id")?e.set("selected",0):c.push(e)))}),b.get("options").at(0)&&this.set("first",b.get("options").at(0).get("id")),a instanceof d&&a.get("selected")&&c.push(a),this.set("selections",c),this.set("no_of_selections",c.length),this.set("updating",!1)}},update_selected:function(){var a=this.get("selections");a.length?this.set("selected",a.at(0).get("id")):this.set("selected",0)},maybe_show_tag_number_field:function(){var a=this.get("selections");this.get("use_tag_numbers")&&a.length&&this.set("show_tag_number_field",!0)},close:function(b,c){b.preventDefault(),a(c).closest(".component").toggleClass("closed").find(".component_inner").slideToggle()}}),g=Backbone.Collection.extend({model:f}),h=Backbone.Model.extend({defaults:{id:null,actions:[],masked_components:[]}}),i=Backbone.Collection.extend({model:h}),j=Backbone.Model.extend({initialize:function(){this.set("components",new g(this.get("components"))),this.set("scenarios",new i(this.get("scenarios"))),this.listenTo(this.get("components"),"change:selections",this.evaluate),this.evaluate()},defaults:{id:null,sku:"",weight:0,components:[],scenarios:[],min_price:0,min_price_incl_tax:0,base_price:0,base_weight:0,base_sku:"",build_sku:!1,price:0,price_incl_tax:0,weight:0,quantity:1,errors:0,selections:0,adding_to_cart:!1},evaluate:function(){b.block({message:null,overlayCSS:{opacity:.6}});var c=this;min_price=parseFloat(this.get("min_price")),min_price_incl_tax=parseFloat(this.get("min_price_incl_tax")),price=parseFloat(this.get("base_price")),price_incl_tax=parseFloat(this.get("base_price_incl_tax")),weight=parseFloat(this.get("base_weight")),sku=[this.get("base_sku")],errors=0,no_of_selections=0,active_scenarios=[],c.get("components").each(function(b){var e=b.get("selections");e.length?e.each(function(e){e instanceof d&&(price+=parseFloat(e.get("price")),price_incl_tax+=parseFloat(e.get("price_incl_tax")),weight+=parseFloat(e.get("weight")),c.get("build_sku")&&b.get("affect_sku")&&(sku[b.get("sku_order")]=e.get("sku")),active_scenarios.length?a.each(active_scenarios,function(b,c){0>a.inArray(c,e.get("scenarios"))&&active_scenarios.splice(b,1)}):a.extend(active_scenarios,e.get("scenarios")),no_of_selections++,b.set("error",!1))}):(c.get("build_sku")&&b.get("affect_sku")&&(sku[b.get("sku_order")]=b.get("sku_default")),b.get("optional")||(errors++,b.set("error",!0)))}),active_scenarios=active_scenarios.length?a.unique(active_scenarios):c.get("scenarios").pluck("id"),c.get("components").each(function(b){b.get("options").each(function(c){if(active_scenarios.length&&!b.get("sovereign")){var d=!1;c.get("scenarios").length&&a.each(c.get("scenarios"),function(b,c){if(a.inArray(c,active_scenarios)>-1)return d=!0,!0}),d?c.set("available",!0):c.set("available",!1)}else c.set("available",!0)})}),this.set("price",Math.max(price,min_price).formatMoney()),this.set("price_incl_tax",Math.max(price_incl_tax,min_price_incl_tax).formatMoney()),this.set("weight",weight.toFixed(1)),this.set("errors",errors),this.set("selections",no_of_selections),this.set("sku",sku.join("")),b.unblock()},get_selections:function(){var a={};return this.get("components").each(function(b){var c=b.get("selections");a[b.get("id")]=[],c?c.each(function(c){a[b.get("id")].push({title:b.get("title"),selected:c.get("title")+(b.get("tag_number")?" <em>Tag Number: "+b.get("tag_number")+"</em>":"")})}):a[b.get("id")].push({title:b.get("title"),selected:b.get("empty_text")})}),a},add_to_cart_click:function(a){a.preventDefault(),b.trigger("submit")},add_to_cart:function(c){if(!k.get("adding_to_cart")){k.set("adding_to_cart",!0),c.preventDefault();var d=wc_add_to_cart_params.wc_ajax_url.toString().replace("%%endpoint%%","add_to_cart"),e={product_id:k.get("id"),product_sku:k.get("sku"),quantity:parseInt(k.get("quantity")),product_price:parseFloat(k.get("price").replace(",","")),product_weight:parseFloat(k.get("weight").replace(",","")),selections:k.get_selections()},f=a(".composite_add_to_cart_button").eq(0);b.block({message:null,overlayCSS:{opacity:.6}}),a(document.body).trigger("adding_to_cart",[f,e]),a.post(d,e,function(b){if(b){var c=window.location.toString();if(c=c.replace("add-to-cart","added-to-cart"),b.error&&b.product_url)return void(window.location=b.product_url);if("yes"===wc_add_to_cart_params.cart_redirect_after_add)return void(window.location=wc_add_to_cart_params.cart_url);var d=b.fragments,e=b.cart_hash;d&&a.each(d,function(b){a(b).addClass("updating")}),d&&a.each(d,function(b,c){a(b).replaceWith(c)}),a(document.body).trigger("added_to_cart",[d,e,f])}},"json").always(function(a){console.log(a),b.unblock(),k.set("adding_to_cart",!1)})}}}),k=new j(wc_cp_product_data);b.on("valid.fndtn.abide",k.add_to_cart),rivets.formatters["="]=function(a,b){return a==b},rivets.formatters["!="]=function(a,b){return a!=b},rivets.formatters["!"]=function(a){return!a},rivets.formatters[">"]=function(a,b){return a>b},rivets.formatters[">="]=function(a,b){return a>=b},rivets.formatters["<"]=function(a,b){return a<b},rivets.formatters["<="]=function(a,b){return a<=b},rivets.formatters.and=function(a,b){return a&&b},rivets.formatters.or=function(a,b){return a||b},rivets.formatters.append=function(a,b){return a+b},rivets.configure({handler:function(a,b,c){this.call(c.model,b,a)}}),rivets.bind(c,{product:k})});