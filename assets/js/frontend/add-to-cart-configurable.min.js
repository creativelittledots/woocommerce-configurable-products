jQuery(document).ready(function($){if('undefined'==typeof wc_cp_product_data)return!1;$.blockUI.defaults.overlayCSS.cursor='default',Number.prototype.formatMoney=function(a,b,f){var g=this,a=isNaN(a=Math.abs(a))?2:a,b=b==void 0?'.':b,f=f==void 0?',':f,h=0>g?'-':'',k=parseInt(g=Math.abs(+g||0).toFixed(a))+'',l=3<(l=k.length)?l%3:0;return h+(l?k.substr(0,l)+f:'')+k.substr(l).replace(/(\d{3})(?=\d)/g,'$1'+f)+(a?b+Math.abs(g-k).toFixed(a).slice(2):'')},String.prototype.ucwords=function(){return this.replace(/^(.)|\s+(.)/g,function(a){return a.toUpperCase()})};var form=$('.js-configurable-product-form'),bindings=$('.js-configurable-product-bind'),Field=Backbone.Model.extend({defaults:{component_id:null,label:'',placeholder:'',value:'',step:1,min:0,max:null,suffix:'',price_formula:'',scenarios:[]},to_selection:function(){var a=this.get('value').toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')+this.get('suffix'),b=Math.max(this.get('value'),this.get('min')),f=this.get('max')?Math.min(b,this.get('max')):b,g=f!=this.get('value');return{title:a,value:f,error:g,formula:this.get('price_formula')}}}),Option=Backbone.Model.extend({initialize:function(){this.on('change:'+this.get('display_price_field'),this.set_display),this.set('price_incl_tax',this.get('display_price_incl_tax')),this.set('price_excl_tax',this.get('display_price_excl_tax')),this.set('formula',this.get('display_formula')),this.set('starting_price_incl_tax',this.get('price_incl_tax')),this.set('starting_price_excl_tax',this.get('price_excl_tax')),this.set('options',new Options(this.get('options'))),this.on('change:available',function(){this.set('selected',!!this.get('available')&&this.get('selected'))}),this.listenTo(this.get('options'),'change:selected',this.evaluate),this.on('change:subselected',function(a,b){this.get('options').each(function(f){f.set('selected',f.id===b)},this)}),this.set_display(),this.evaluate()},defaults:{id:null,title:'',display:'',display_price_field:'price_excl_tax',price_incl_tax:0,price_excl_tax:0,display_price_incl_tax:0,display_price_excl_tax:0,starting_price_incl_tax:0,starting_price_excl_tax:0,formatted_price:'',formula:'{p}',display_formula:'{p}',weight:0,sku:'',recommended:!1,available:!1,scenarios:[],options:[],selections:[],selected:!1,subselected:0},evaluate:function(){var a=this.get('options').where({selected:!0})||[];this.set('selections',new Options(a))},set_display:function(){this.set('formatted_price',wc_cp_product_data.priced_per_product&&0<this.get(this.get('display_price_field'))?'+'+wc_cp_params.currency+parseFloat(this.get(this.get('display_price_field'))).formatMoney():''),this.set('display',this.get('title')+(this.get('formatted_price')?' <strong>['+this.get('formatted_price')+']</strong>':'')+(this.get('recommended')?' <em>Recommended</em>':''))},calculate_price:function(a){this.set('price_incl_tax',this.get_calculated_price(this.get('starting_price_incl_tax'),a)),this.set('price_excl_tax',this.get_calculated_price(this.get('starting_price_excl_tax'),a))},get_calculated_price:function(price,components){var formula=this.get('formula').replace('{p}',price);if(-1<formula.indexOf('{n')){var i=0;components.each(function(a){var b=a.get('selections');if(i++,formula=formula.replace('{n'+i+'}',b instanceof PriceFormulas?b.at(0).get('value'):0),-1==formula.indexOf('{n'))return!1})}return eval(formula)}}),Options=Backbone.Collection.extend({model:Option}),PriceFormula=Backbone.Model.extend({initialize:function(){this.calculate_price()},defaults:{title:'',value:0,formula:'',error:!1,price_incl_tax:0,price_excl_tax:0},calculate_price:function(){this.set('price_incl_tax',this.get_price(!0)),this.set('price_excl_tax',this.get_price())},get_price:function(incl_tax){var price=eval(this.get('formula').replace('{n}',this.get('value')));return incl_tax?price*1.2:price}}),PriceFormulas=Backbone.Collection.extend({model:PriceFormula}),Component=Backbone.Model.extend({initialize:function(){switch(this.set('empty_text',this.get('empty_text')+(this.get('optional')?' (optional)':' (required)')),this.set('options',new Options(this.get('options'))),this.set('components',new Components(this.get('components'))),this.set('field',new Field(this.get('field'))),this.on('change:no_of_selections',function(){this.set('show_summary',!!this.get('no_of_selections')),this.set('show_title',1<this.get('no_of_selections')||this.get('no_of_selections')&&this.get('field').get('id'))}),this.on('change:subselected',function(f,g){this.get('options').each(function(h){h.set('selected',h.id===g)},this)}),this.listenTo(this.get('options'),'change:selected',this.evaluate),this.listenTo(this.get('options'),'change:selections',function(){this.trigger('change:selections',this,this.get('selections'))},this),this.listenTo(this.get('components'),'change:selections',function(){var f=this.get('components').filter(function(g){return g.get('selections')});this.set('show_summary',!!f.length),this.set('show_title',!!f.length),this.trigger('change:selections',this,this.get('selections'))}),this.get('style')){case'number':case'text':this.get('field').on('change:value',function(f){var g='number'==this.get('style')?PriceFormulas:Backbone.Collection;this.set('selections',new g(f.get('value')?[f.to_selection()]:[])),this.set('no_of_selections',f.get('value')?1:0)},this).trigger('change:value',this.get('field'),this.get('field').get('value'));break;default:switch(this.get('style')){case'checkboxes':break;default:var b=this.get('options').findWhere({selected:!0})||[];this.set('subselected',b.id||0);}this.evaluate();}},defaults:{id:null,name:'',title:'',style:'dropdown',field:null,options:[],selections:[],subselected:0,components:[],no_of_selections:0,optional:!1,error:!1,sku_order:0,sku_default:'',affect_sku:!1,empty_text:'None',updating:!1,sovereign:!1,available:!0,show_summary:!1,show_title:!1},evaluate:function(){var a=this.get('options').where({selected:!0})||[];this.set('selections',new Options(a)),this.set('no_of_selections',a.length)},close:function(a,b){a.preventDefault(),$(b).closest('.component').toggleClass('closed').find('.component_inner').slideToggle()}}),Components=Backbone.Collection.extend({model:Component}),Scenario=Backbone.Model.extend({defaults:{id:null,actions:[],masked_components:[]}}),Scenarios=Backbone.Collection.extend({model:Scenario}),Evaluator=Backbone.Model.extend({defaults:{product:null,price_incl_tax:0,price_excl_tax:0,weight:0,no_of_errors:0,no_of_selections:0,sku:'',active_scenarios:[],selections:[],errors:[]},evaluate_selection:function(a,b,f){var g=this.get('product');if(this.attributes.selections.push({title:b.get('title'),selected:a.get('title').ucwords()===b.get('title').ucwords()?'\u2713':(f?'- ':'')+a.get('title'),product_id:a.get('product_id'),affect_stock:a.get('affect_stock')}),a instanceof Option){if(this.attributes.price_incl_tax+=parseFloat(a.get('price_incl_tax')),this.attributes.price_excl_tax+=parseFloat(a.get('price_excl_tax')),this.attributes.weight+=parseFloat(a.get('weight')||0),g.get('build_sku')&&b.get('affect_sku')&&(this.attributes.sku[b.get('sku_order')]=this.attributes.sku[b.get('sku_order')]||[],this.attributes.sku[b.get('sku_order')].push(a.get('sku'))),this.attributes.active_scenarios.length)for(var h=0;h<this.attributes.active_scenarios.length;h++)0>$.inArray(this.attributes.active_scenarios[h],a.get('scenarios'))&&(this.attributes.active_scenarios.splice(h,1),h--);else $.extend(this.attributes.active_scenarios,a.get('scenarios'));this.attributes.no_of_selections++,b.set('error',!1),a.get('selections').each(function(k){this.evaluate_selection(k,b,!0)},this)}else a instanceof PriceFormula&&(this.attributes.price_incl_tax+=parseFloat(a.get('price_incl_tax')),this.attributes.price_excl_tax+=parseFloat(a.get('price_excl_tax')),b.set('error',a.get('error')),b.get('error')?this.attributes.no_of_errors++:this.attributes.no_of_selections++)},evaluate_component:function(a){var b=this.get('product'),f=a.get('options'),g=a.get('selections');f.length&&f.each(function(h){h.calculate_price(b.get('components'))},this),g.length?g.each(function(h){this.evaluate_selection(h,a)},this):(b.get('build_sku')&&a.get('affect_sku')&&(this.attributes.sku[a.get('sku_order')]=a.get('sku_default')),!a.get('optional')&&'subcomponents'!==a.get('source')&&(this.attributes.no_of_errors++,a.set('error',!0))),a.get('components').each(this.evaluate_component,this)},evaluate_option:function(a,b){a.set('available',b.get('sovereign')||!this.get('product').get('scenarios').length||_.intersection(_.map(a.get('scenarios'),Number),_.map(this.attributes.active_scenarios,Number)).length),a.get('available')||(a.set('selected',!1),b.get('subselected')==a.id&&b.set('subselected',0)),a.get('options').each(function(f){this.evaluate_option(f,b)},this)},evaluate_options:function(a){a.get('options').each(function(b){this.evaluate_option(b,a)},this),a.set('available',!a.get('field')||a.get('sovereign')||!this.get('product').get('scenarios').length||_.intersection(_.map(a.get('field').get('scenarios'),Number),_.map(this.attributes.active_scenarios,Number)).length),a.get('components').each(this.evaluate_options,this)},evaluate_errors:function(a){a.get('error')&&this.attributes.errors.push({title:a.get('title')}),a.get('components').each(this.evaluate_errors,this)},evaluate:function(){var a=this.get('product');this.attributes.price_incl_tax=parseFloat(a.get('base_price_incl_tax')),this.attributes.price_excl_tax=parseFloat(a.get('base_price_excl_tax')),this.attributes.weight=parseFloat(a.get('base_weight')),this.attributes.sku=a.get('build_sku')?[a.get('base_sku')]:[a.get('sku')],this.attributes.no_of_errors=0,this.attributes.no_of_selections=0,this.attributes.active_scenarios=[],this.attributes.selections=[],this.attributes.errors=[],a.get('components').each(this.evaluate_component,this),this.attributes.active_scenarios=this.attributes.active_scenarios.length?$.unique(this.attributes.active_scenarios):a.get('scenarios').pluck('id'),a.get('components').each(this.evaluate_options,this),this.set('price_incl_tax',Math.max(this.attributes.price_incl_tax,parseFloat(a.get('min_price_incl_tax'))).formatMoney()),this.set('price_excl_tax',Math.max(this.attributes.price_excl_tax,parseFloat(a.get('min_price_excl_tax'))).formatMoney()),this.set('weight',this.attributes.weight.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')),this.set('sku',[].concat.apply([],this.attributes.sku).join('')),this.set('selections',new Backbone.Collection(this.get('selections'))),a.get('components').each(this.evaluate_errors,this),this.set('errors',new Backbone.Collection(this.get('errors')))}}),Product=Backbone.Model.extend({initialize:function(){this.set('components',new Components(this.get('components'))),this.set('scenarios',new Scenarios(this.get('scenarios'))),this.listenTo(this.get('components'),'change:selections',this.evaluate),this.evaluate()},defaults:{id:null,sku:'',weight:0,components:[],scenarios:[],min_price_incl_tax:0,min_price_excl_tax:0,base_price_incl_tax:0,base_price_excl_tax:0,base_weight:0,base_sku:'',build_sku:!1,price_incl_tax:0,price_excl_tax:0,weight:0,quantity:1,no_of_errors:0,no_of_selections:0,selections:[],errors:[],adding_to_cart:!1},evaluate:function(){form.block({message:null,overlayCSS:{opacity:0.6}});var a=new Evaluator({product:this});a.evaluate(),this.set('price_incl_tax',a.get('price_incl_tax')),this.set('price_excl_tax',a.get('price_excl_tax')),this.set('weight',a.get('weight')),this.set('no_of_selections',a.get('no_of_selections')),this.set('no_of_errors',a.get('no_of_errors')),this.set('errors',a.get('errors')),this.set('selections',a.get('selections')),this.set('sku',a.get('sku')),form.unblock()},add_to_cart_click:function(a){a.preventDefault(),form.trigger('submit')},add_to_cart:function(a){if(!product.get('adding_to_cart')&&!product.get('no_of_errors')){product.set('adding_to_cart',!0),a.preventDefault();var b=wc_add_to_cart_params.wc_ajax_url.toString().replace('%%endpoint%%','add_to_cart'),f={product_id:product.get('id'),product_sku:product.get('sku'),quantity:parseInt(product.get('quantity')),price_incl_tax:parseFloat(product.get('price_incl_tax').replace(',','')),price_excl_tax:parseFloat(product.get('price_excl_tax').replace(',','')),weight:parseFloat(product.get('weight')),display_weight:product.get('weight')+wc_cp_product_data.weight_unit,selections:product.get('selections').toJSON()},g=$('.configurable_add_to_cart_button').eq(0);form.block({message:null,overlayCSS:{opacity:0.6}}),$(document.body).trigger('adding_to_cart',[g,f]),$.post(b,f,function(h){if(h){var k=window.location.toString();if(k=k.replace('add-to-cart','added-to-cart'),h.error&&h.product_url)return void(window.location=h.product_url);if('yes'===wc_add_to_cart_params.cart_redirect_after_add)return void(window.location=wc_add_to_cart_params.cart_url);var l=h.fragments,m=h.cart_hash;l&&$.each(l,function(o){$(o).addClass('updating')}),l&&$.each(l,function(o,p){$(o).replaceWith(p)}),$(document.body).trigger('added_to_cart',[l,m,g])}},'json').always(function(){form.unblock(),product.set('adding_to_cart',!1)})}}}),product=new Product(wc_cp_product_data);form.on('valid.fndtn.abide',product.add_to_cart),rivets.formatters['=']=function(a,b){return a==b},rivets.formatters['!=']=function(a,b){return a!=b},rivets.formatters['!']=function(a){return!a},rivets.formatters['>']=function(a,b){return parseFloat(a)>parseFloat(b)},rivets.formatters['>=']=function(a,b){return parseFloat(a)>=parseFloat(b)},rivets.formatters['<']=function(a,b){return parseFloat(a)<parseFloat(b)},rivets.formatters['<=']=function(a,b){return parseFloat(a)<=parseFloat(b)},rivets.formatters['&&']=function(a,b){return a&&b},rivets.formatters['^']=function(a,b){return a||b},rivets.formatters.IN=function(a,b){return-1<b.indexOf(a)},rivets.formatters.append=function(a,b){return a+b},rivets.configure({handler:function(a,b,f){this.call(f.model,b,a)}}),rivets.components.component={template:function(){return document.querySelector('.js-component-component').innerHTML},initialize:function(a,b){return b}},rivets.components.component_inner={template:function(){return document.querySelector('.js-component-component_inner').innerHTML},initialize:function(a,b){return b}},rivets.components.selection={template:function(){return document.querySelector('.js-component-selection').innerHTML},initialize:function(a,b){return b.depth++,b}},rivets.bind(bindings,{product:product})});