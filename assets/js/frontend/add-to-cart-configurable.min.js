jQuery(document).ready(function($){if("undefined"==typeof wc_cp_product_data)return!1;$.blockUI.defaults.overlayCSS.cursor="default",Number.prototype.formatMoney=function(t,e,i){var s=this,t=isNaN(t=Math.abs(t))?2:t,e=void 0==e?".":e,i=void 0==i?",":i,o=s<0?"-":"",n=parseInt(s=Math.abs(+s||0).toFixed(t))+"",a=(a=n.length)>3?a%3:0;return o+(a?n.substr(0,a)+i:"")+n.substr(a).replace(/(\d{3})(?=\d)/g,"$1"+i)+(t?e+Math.abs(s-n).toFixed(t).slice(2):"")},String.prototype.ucwords=function(){return this.replace(/^(.)|\s+(.)/g,function(t){return t.toUpperCase()})};var form=$(".js-configurable-product-form"),bindings=$(".js-configurable-product-bind"),Field=Backbone.Model.extend({defaults:{component_id:null,label:"",placeholder:"",value:"",step:1,min:0,max:null,suffix:"",price_formula:"",scenarios:[]},to_selection:function(){var t=this.get("value").toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+this.get("suffix"),e=Math.max(this.get("value"),this.get("min")),i=this.get("max")?Math.min(e,this.get("max")):e;return{title:t,value:i,error:i!=this.get("value"),formula:this.get("price_formula")}}}),Option=Backbone.Model.extend({initialize:function(){this.on("change:"+this.get("display_price_field"),this.set_display),this.set("price_incl_tax",this.get("display_price_incl_tax")),this.set("price_excl_tax",this.get("display_price_excl_tax")),this.set("formula",this.get("display_formula")),this.set("starting_price_incl_tax",this.get("price_incl_tax")),this.set("starting_price_excl_tax",this.get("price_excl_tax")),this.set("options",new Options(this.get("options"))),this.on("change:available",function(){this.set("selected",!!this.get("available")&&this.get("selected"))}),this.listenTo(this.get("options"),"change:selected",this.evaluate),this.on("change:subselected",function(t,e){this.get("options").each(function(t){t.set("selected",t.id===e)},this)}),this.set_display(),this.evaluate()},defaults:{id:null,title:"",display:"",display_price_field:"price_excl_tax",price_incl_tax:0,price_excl_tax:0,display_price_incl_tax:0,display_price_excl_tax:0,starting_price_incl_tax:0,starting_price_excl_tax:0,formatted_price:"",formula:"{p}",display_formula:"{p}",weight:0,sku:"",recommended:!1,available:!1,scenarios:[],options:[],selections:[],selected:!1,subselected:0},evaluate:function(){var t=this.get("options").where({selected:!0})||[];this.set("selections",new Options(t))},set_display:function(){this.set("formatted_price",wc_cp_product_data.priced_per_product&&this.get(this.get("display_price_field"))>0?"+"+wc_cp_params.currency+parseFloat(this.get(this.get("display_price_field"))).formatMoney():""),this.set("display",this.get("title")+(this.get("formatted_price")?" <strong>["+this.get("formatted_price")+"]</strong>":"")+(this.get("recommended")?" <em>Recommended</em>":""))},calculate_price:function(t){this.set("price_incl_tax",this.get_calculated_price(this.get("starting_price_incl_tax"),t)),this.set("price_excl_tax",this.get_calculated_price(this.get("starting_price_excl_tax"),t))},get_calculated_price:function(price,components){var formula=this.get("formula").replace("{p}",price);if(formula.indexOf("{n")>-1){var i=0;components.each(function(t){var e=t.get("selections");if(i++,-1==(formula=formula.replace("{n"+i+"}",e instanceof PriceFormulas?e.at(0).get("value"):0)).indexOf("{n"))return!1})}return eval(formula)}}),Options=Backbone.Collection.extend({model:Option}),PriceFormula=Backbone.Model.extend({initialize:function(){this.calculate_price()},defaults:{title:"",value:0,formula:"",error:!1,price_incl_tax:0,price_excl_tax:0},calculate_price:function(){this.set("price_incl_tax",this.get_price(!0)),this.set("price_excl_tax",this.get_price())},get_price:function(incl_tax){var price=eval(this.get("formula").replace("{n}",this.get("value"))),tax_rate=1.2;return incl_tax?price*tax_rate:price}}),PriceFormulas=Backbone.Collection.extend({model:PriceFormula}),Component=Backbone.Model.extend({initialize:function(t){switch(this.set("empty_text",this.get("empty_text")+(this.get("optional")?" (optional)":" (required)")),this.set("options",new Options(this.get("options"))),this.set("components",new Components(this.get("components"))),this.set("field",new Field(this.get("field"))),this.on("change:no_of_selections",function(){this.set("show_summary",!!this.get("no_of_selections")),this.set("show_title",this.get("no_of_selections")>1||this.get("no_of_selections")&&this.get("field").get("id"))}),this.on("change:subselected",function(t,e){this.get("options").each(function(t){t.set("selected",t.id===e)},this)}),this.listenTo(this.get("options"),"change:selected",this.evaluate),this.listenTo(this.get("options"),"change:selections",function(){this.trigger("change:selections",this,this.get("selections"))},this),this.listenTo(this.get("components"),"change:selections",function(){var t=this.get("components").filter(function(t){return t.get("selections")});this.set("show_summary",!!t.length),this.set("show_title",!!t.length),this.trigger("change:selections",this,this.get("selections"))}),this.get("style")){case"number":case"text":this.get("field").on("change:value",function(t){var e="number"==t.get("type")?PriceFormulas:Backbone.Collection;this.set("selections",new e(t.get("value")?[t.to_selection()]:[])),this.set("no_of_selections",t.get("value")?1:0)},this).trigger("change:value",this.get("field"),this.get("field").get("value"));break;default:switch(this.get("style")){case"checkboxes":break;default:var e=this.get("options").findWhere({selected:!0})||[];this.set("subselected",e.id||0)}this.evaluate()}},defaults:{id:null,name:"",title:"",style:"dropdown",field:null,options:[],selections:[],subselected:0,components:[],no_of_selections:0,optional:!1,error:!1,sku_order:0,sku_default:"",affect_sku:!1,empty_text:"None",updating:!1,sovereign:!1,available:!0,show_summary:!1,show_title:!1},evaluate:function(){var t=this.get("options").where({selected:!0})||[];this.set("selections",new Options(t)),this.set("no_of_selections",t.length)},close:function(t,e){t.preventDefault(),$(e).closest(".component").toggleClass("closed").find(".component_inner").slideToggle()}}),Components=Backbone.Collection.extend({model:Component}),Scenario=Backbone.Model.extend({defaults:{id:null,actions:[],masked_components:[]}}),Scenarios=Backbone.Collection.extend({model:Scenario}),Evaluator=Backbone.Model.extend({defaults:{product:null,price_incl_tax:0,price_excl_tax:0,weight:0,no_of_errors:0,no_of_selections:0,sku:"",active_scenarios:[],selections:[],errors:[]},evaluate_selection:function(t,e,i){var s=this.get("product");if(this.attributes.selections.push({title:e.get("title"),selected:t.get("title").ucwords()===e.get("title").ucwords()?"âœ“":(i?"- ":"")+t.get("title"),product_id:t.get("product_id"),affect_stock:t.get("affect_stock")}),t instanceof Option){if(this.attributes.price_incl_tax+=parseFloat(t.get("price_incl_tax")),this.attributes.price_excl_tax+=parseFloat(t.get("price_excl_tax")),this.attributes.weight+=parseFloat(t.get("weight")||0),s.get("build_sku")&&e.get("affect_sku")&&(this.attributes.sku[e.get("sku_order")]=this.attributes.sku[e.get("sku_order")]||[],this.attributes.sku[e.get("sku_order")].push(t.get("sku"))),this.attributes.active_scenarios.length)for(var o=0;o<this.attributes.active_scenarios.length;o++)0>$.inArray(this.attributes.active_scenarios[o],t.get("scenarios"))&&(this.attributes.active_scenarios.splice(o,1),o--);else $.extend(this.attributes.active_scenarios,t.get("scenarios"));this.attributes.no_of_selections++,e.set("error",!1),t.get("selections").each(function(t){this.evaluate_selection(t,e,!0)},this)}else t instanceof PriceFormula&&(this.attributes.price_incl_tax+=parseFloat(t.get("price_incl_tax")),this.attributes.price_excl_tax+=parseFloat(t.get("price_excl_tax")),e.set("error",t.get("error")),e.get("error")?this.attributes.no_of_errors++:this.attributes.no_of_selections++)},evaluate_component:function(t){var e=this.get("product"),i=t.get("options"),s=t.get("selections");i.length&&i.each(function(t){t.calculate_price(e.get("components"))},this),s.length?s.each(function(e){this.evaluate_selection(e,t)},this):(e.get("build_sku")&&t.get("affect_sku")&&(this.attributes.sku[t.get("sku_order")]=t.get("sku_default")),t.get("optional")||"subcomponents"===t.get("source")||(this.attributes.no_of_errors++,t.set("error",!0))),t.get("components").each(this.evaluate_component,this)},evaluate_option:function(t,e){t.set("available",!(!e.get("sovereign")&&this.get("product").get("scenarios").length&&!_.intersection(_.map(t.get("scenarios"),Number),_.map(this.attributes.active_scenarios,Number)).length)),t.get("available")||(t.set("selected",!1),e.get("subselected")==t.id&&e.set("subselected",0)),t.get("options").each(function(t){this.evaluate_option(t,e)},this)},evaluate_options:function(t){t.get("options").each(function(e){this.evaluate_option(e,t)},this),t.set("available",!(t.get("field")&&!t.get("sovereign")&&this.get("product").get("scenarios").length&&!_.intersection(_.map(t.get("field").get("scenarios"),Number),_.map(this.attributes.active_scenarios,Number)).length)),t.get("components").each(this.evaluate_options,this)},evaluate_errors:function(t){t.get("error")&&this.attributes.errors.push({title:t.get("title")}),t.get("components").each(this.evaluate_errors,this)},evaluate:function(){var t=this.get("product");this.attributes.price_incl_tax=parseFloat(t.get("base_price_incl_tax")),this.attributes.price_excl_tax=parseFloat(t.get("base_price_excl_tax")),this.attributes.weight=parseFloat(t.get("base_weight")),this.attributes.sku=t.get("build_sku")?[t.get("base_sku")]:[t.get("sku")],this.attributes.no_of_errors=0,this.attributes.no_of_selections=0,this.attributes.active_scenarios=[],this.attributes.selections=[],this.attributes.errors=[],t.get("components").each(this.evaluate_component,this),this.attributes.active_scenarios=this.attributes.active_scenarios.length?$.unique(this.attributes.active_scenarios):t.get("scenarios").pluck("id"),t.get("components").each(this.evaluate_options,this),this.set("price_incl_tax",Math.max(this.attributes.price_incl_tax,parseFloat(t.get("min_price_incl_tax"))).formatMoney()),this.set("price_excl_tax",Math.max(this.attributes.price_excl_tax,parseFloat(t.get("min_price_excl_tax"))).formatMoney()),this.set("weight",this.attributes.weight.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")),this.set("sku",[].concat.apply([],this.attributes.sku).join("")),this.set("selections",new Backbone.Collection(this.get("selections"))),t.get("components").each(this.evaluate_errors,this),this.set("errors",new Backbone.Collection(this.get("errors")))}}),Product=Backbone.Model.extend({initialize:function(){this.set("components",new Components(this.get("components"))),this.set("scenarios",new Scenarios(this.get("scenarios"))),this.listenTo(this.get("components"),"change:selections",this.evaluate),this.evaluate()},defaults:{id:null,sku:"",weight:0,components:[],scenarios:[],min_price_incl_tax:0,min_price_excl_tax:0,base_price_incl_tax:0,base_price_excl_tax:0,base_weight:0,base_sku:"",build_sku:!1,price_incl_tax:0,price_excl_tax:0,weight:0,quantity:1,no_of_errors:0,no_of_selections:0,selections:[],errors:[],adding_to_cart:!1},evaluate:function(){form.block({message:null,overlayCSS:{opacity:.6}});var t=new Evaluator({product:this});t.evaluate(),this.set("price_incl_tax",t.get("price_incl_tax")),this.set("price_excl_tax",t.get("price_excl_tax")),this.set("weight",t.get("weight")),this.set("no_of_selections",t.get("no_of_selections")),this.set("no_of_errors",t.get("no_of_errors")),this.set("errors",t.get("errors")),this.set("selections",t.get("selections")),this.set("sku",t.get("sku")),form.unblock()},add_to_cart_click:function(t){t.preventDefault(),form.trigger("submit")},add_to_cart:function(t){if(!product.get("adding_to_cart")&&!product.get("no_of_errors")){product.set("adding_to_cart",!0),t.preventDefault();var e=wc_add_to_cart_params.wc_ajax_url.toString().replace("%%endpoint%%","add_to_cart"),i={product_id:product.get("id"),product_sku:product.get("sku"),quantity:parseInt(product.get("quantity")),price_incl_tax:parseFloat(product.get("price_incl_tax").replace(",","")),price_excl_tax:parseFloat(product.get("price_excl_tax").replace(",","")),weight:parseFloat(product.get("weight")),display_weight:product.get("weight")+wc_cp_product_data.weight_unit,selections:product.get("selections").toJSON()},s=$(".configurable_add_to_cart_button").eq(0);form.block({message:null,overlayCSS:{opacity:.6}}),$(document.body).trigger("adding_to_cart",[s,i]),$.post(e,i,function(t){if(t){var e=window.location.toString();if(e=e.replace("add-to-cart","added-to-cart"),t.error&&t.product_url)window.location=t.product_url;else if("yes"!==wc_add_to_cart_params.cart_redirect_after_add){var i=t.fragments,o=t.cart_hash;i&&$.each(i,function(t){$(t).addClass("updating")}),i&&$.each(i,function(t,e){$(t).replaceWith(e)}),$(document.body).trigger("added_to_cart",[i,o,s])}else window.location=wc_add_to_cart_params.cart_url}},"json").always(function(t){form.unblock(),product.set("adding_to_cart",!1)})}}}),product=new Product(wc_cp_product_data);form.on("valid.fndtn.abide",product.add_to_cart),rivets.formatters["="]=function(t,e){return t==e},rivets.formatters["!="]=function(t,e){return t!=e},rivets.formatters["!"]=function(t){return!t},rivets.formatters[">"]=function(t,e){return parseFloat(t)>parseFloat(e)},rivets.formatters[">="]=function(t,e){return parseFloat(t)>=parseFloat(e)},rivets.formatters["<"]=function(t,e){return parseFloat(t)<parseFloat(e)},rivets.formatters["<="]=function(t,e){return parseFloat(t)<=parseFloat(e)},rivets.formatters["&&"]=function(t,e){return t&&e},rivets.formatters["^"]=function(t,e){return t||e},rivets.formatters.IN=function(t,e){return e.indexOf(t)>-1},rivets.formatters.append=function(t,e){return t+e},rivets.configure({handler:function(t,e,i){this.call(i.model,e,t)}}),rivets.components.component={template:function(){return document.querySelector(".js-component-component").innerHTML},initialize:function(t,e){return e}},rivets.components.component_inner={template:function(){return document.querySelector(".js-component-component_inner").innerHTML},initialize:function(t,e){return e}},rivets.components.selection={template:function(){return document.querySelector(".js-component-selection").innerHTML},initialize:function(t,e){return e.depth++,e}},rivets.bind(bindings,{product:product})});