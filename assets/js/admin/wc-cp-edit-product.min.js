jQuery(function(e){function t(){e(".help_tip").tipTip({attribute:"tip",fadeIn:50,fadeOut:50,delay:200})}function n(){return{language:{errorLoading:function(){return wc_enhanced_select_params.i18n_searching},inputTooLong:function(e){var t=e.input.length-e.maximum;return 1===t?wc_enhanced_select_params.i18n_input_too_long_1:wc_enhanced_select_params.i18n_input_too_long_n.replace("%qty%",t)},inputTooShort:function(e){var t=e.minimum-e.input.length;return 1===t?wc_enhanced_select_params.i18n_input_too_short_1:wc_enhanced_select_params.i18n_input_too_short_n.replace("%qty%",t)},loadingMore:function(){return wc_enhanced_select_params.i18n_load_more},maximumSelected:function(e){return 1===e.maximum?wc_enhanced_select_params.i18n_selection_too_long_1:wc_enhanced_select_params.i18n_selection_too_long_n.replace("%qty%",e.maximum)},noResults:function(){return wc_enhanced_select_params.i18n_no_matches},searching:function(){return wc_enhanced_select_params.i18n_searching}}}}function i(){e("#configuration_components").find(":input.js-wc-product-search").each(function(){var t={allowClear:!!e(this).data("allow_clear"),placeholder:e(this).data("placeholder"),minimumInputLength:3,escapeMarkup:function(e){return e},ajax:{url:wc_enhanced_select_params.ajax_url,dataType:"json",quietMillis:250,data:function(t){return{term:t.term,action:e(this).data("action")||"woocommerce_cp_json_search_products",product_type:e(this).attr("product_type").replace("-product","")||"simple",security:wc_enhanced_select_params.search_products_nonce}},processResults:function(t){var n=[];return t&&e.each(t,function(e,t){n.push({id:e,text:t.text,title:t.title})}),{results:n}},cache:!0}};t=e.extend(t,n()),e(this).select2(t).addClass("enhanced").on("select2:selecting",function(t){e(this).siblings(".js-wc-product-search").val(t.params.args.data.id).trigger("change"),e(this).closest(".wc-metabox").find(".js-wc-product-search-title").eq(0).text(t.params.args.data.title)})}),e("#configuration_scenarios").find(":input.js-wc-product-select").each(function(){var t={allowClear:!!e(this).data("allow_clear"),placeholder:e(this).data("placeholder")};t=e.extend(t,n()),e(this).select2(t).addClass("enhanced")})}function o(){e(".js-wc-cp-editor").each(function(){if(e(this).attr("id")&&void 0!==e(this).attr("id")&&!e(this).hasClass("editor-instantiated")){var t=tinyMCEPreInit.mceInit.content;t.selector="#"+e(this).attr("id"),t.setup=function(t){e(t.getElement()).addClass("editor-instantiated"),t.on("change",function(){t.save(),e(t.getElement()).trigger("change")})},tinymce.init(t)}})}function s(){o(),t(),i(),e(".js-sortable").sortable({exclude:".js-component-list li",onDragStart:function(e){e.addClass("dragged")},onDrop:function(t){t.removeClass("dragged"),t.closest(".js-sortable").find(">li").each(function(t,n){e(this).data("positon",t).find(".js-item-position").val(t+1).trigger("change")})},tolerance:-10,isValidTarget:function(e,t){return e.closest(".js-sortable")[0]===t.el[0]}})}if("undefined"==typeof wc_cp_admin_params)return!1;e.blockUI.defaults.overlayCSS.cursor="default";var c=e(".js-cp-product-bind");e("body").on("click",".js-wc-cp-upload-image",function(t){t.preventDefault();var n=e(this),i=wp.media({title:"Insert image",library:{type:"image"},button:{text:"Use this image"},multiple:!1}).on("select",function(){var t=i.state().get("selection").first().toJSON();e(n).removeClass("button").html('<img class="true_pre_image" src="'+t.url+'" style="max-width:95%;display:block;" />').next().val(t.id).next().show()}).open()});var r=Backbone.Model.extend({defaults:{closed:!0,position:1},open:function(t){var n=e(t.currentTarget).next().is(":visible");setTimeout(_.bind(function(){this.set("closed",n)},this),100)}}),a=r.extend({addItem:function(e,t,n){e.preventDefault();var i=t+"s";this.attributes[i].models.push(n),this.attributes[i].trigger("add"),this.trigger("change"),this.trigger("change:"+i),s()},removeItem:function(t,n){t.preventDefault();var i=n+"s",o=e(t.currentTarget).attr(n+"_cid");this.get(i).remove(o),this.trigger("change"),this.trigger("change:"+i)}}).extend({addOption:function(e){this.addItem(e,"option",new u({closed:!1}))},removeOption:function(e){this.removeItem(e,"option")}}),l=a.extend({addComponent:function(e){this.addItem(e,"component",new h({closed:!1}))},removeComponent:function(e){this.removeItem(e,"component")}}),u=a.extend({type:"option",initialize:function(){this.on("change",s),this.set("options",new m(this.get("options"),{silent:!1})),this.on("change:label change:source",function(){this.set("title","static"==this.get("source")?this.get("label"):this.get("product_title"))})},defaults:_.extend({},a.prototype.defaults,{title:"",product_title:"",component_id:null,option_id:null,source:"simple-product",product_id:null,value:"",label:"",affect_stock:0,selected:0,recommended:0,sku:"",price:"",formula:"{p}",nested_options:0,options:[]}),updateLabel:function(){this.trigger("change:label"),this.trigger("change")},updateSource:function(){this.trigger("change:source"),this.trigger("change")}}),d=Backbone.Model.extend({defaults:{component_id:null,label:"",placeholder:"",value:"",step:1,min:0,max:null,suffix:"",price_formula:""}}),p=Backbone.Collection.extend({initialize:function(){this.on("reset add update",function(){this.map(function(e){e.set("position",this.indexOf(e)+1)},this)})}}),m=p.extend({model:u}),h=l.extend({type:"component",initialize:function(){this.on("change",s),this.set("components",new f(this.get("components"),{silent:!1})),this.set("options",new m(this.get("options"),{silent:!1})),this.set("field",new d(this.get("field")))},defaults:_.extend({},l.prototype.defaults,{tab:"settings",title:"",source:"default",style:"dropdown",options:new m,field:new d,components:[]}),tab:function(t){this.set("tab",e(t.currentTarget).data("tab"))}}),f=p.extend({model:h}),g=r.extend({type:"scenario_component",initialize:function(){this.on("change:allow_all",s)},defaults:_.extend({},r.prototype.defaults,{component_cid:null,component_id:null,scenario_id:null,allow_all:!0,allow_field:!0,modifier:"in",options:[]})}),v=p.extend({model:g}),b=r.extend({type:"scenario",initialize:function(){this.on("change",s),this.set("components",new v(this.get("components")))},addComponent:function(e,t){var t=(t||this).get("components").add({component_cid:e.cid,component_id:e.get("id")});return e.get("components").each(function(e){this.addComponent(e,t)}),this.trigger("change"),this.trigger("change:components"),t},removeComponent:function(e){(e=this.get("components").findWhere({component_cid:e.cid}))&&(e.remove(),this.trigger("change"),this.trigger("change:components"))},defaults:_.extend({},r.prototype.defaults,{title:"",description:"",active:!0,components:[]})}),w=p.extend({model:b}),x=new(l.extend({syncedScenarios:!1,url:function(){return ajaxurl+"?action=wc_cp_save_configuration&security="+wc_cp_admin_params.save_configuration_nonce},initialize:function(){this.on("change",s),this.on("sync",function(){this.set("scenarios",new w(this.get("scenarios"),{silent:!1})),this.set("components",new f(this.get("components"),{silent:!1}))}),this.listenTo(this.get("components"),"remove",this.removeScenarioComponents),this.trigger("sync")},defaults:{style:"stacked",build_sku:!1,promise:!1,components:new f,scenarios:new w},addScenario:function(e){var t=new b({closed:!1});this.addItem(e,"scenario",t)},removeScenarioComponents:function(e){this.get("scenarios").each(function(t){t.removeComponnt(e)})},removeScenario:function(e){this.removeItem(e,"scenario")},saveConfiguration:function(t){var n=e(t.currentTarget).closest(".js-cp-product-bind");n.block({message:null,overlayCSS:{opacity:.6}}),this.save(null,{success:_.bind(function(t,n){this.promise&&e("#publish").trigger("click")},this),error:function(e,t){alert(JSON.parse(t.responseText).data.message)}}).always(function(){n.unblock()})}}))(wc_cp_admin_params.product);e("#publish").click(function(t){x.promise||(t.preventDefault(),e(this).addClass("button-primary-disabled").siblings(".spinner").addClass("is-active"),x.promise=!0,e(".js-save-configuration").trigger("click"))}),rivets.formatters[">"]=function(e,t){return parseFloat(e)>parseFloat(t)},rivets.formatters["="]=function(e,t){return e==t},rivets.formatters.length=function(e){return e.length},rivets.formatters.even=function(e){return e%2==0},rivets.formatters.odd=function(e){return e%2!=0},rivets.formatters["!="]=function(e,t){return e!=t},rivets.formatters.append=function(e,t){return e+t},rivets.formatters.AND=function(e,t){return e&&t},rivets.formatters.IN=function(e,t){return t&&t.indexOf(e)>-1},rivets.formatters.NOTIN=function(e,t){return!t||-1==t.indexOf(e)},rivets.formatters.has=function(e,t){return!!(e instanceof Backbone.Collection&&e.get(t))},rivets.configure({handler:function(e,t,n){this.call(n.model,t,e)}}),rivets.components.component={template:function(){return document.querySelector("#component").innerHTML},initialize:function(e,t){return t}},rivets.components.selection={template:function(){return document.querySelector("#selection").innerHTML},initialize:function(e,t){return t.depth++,t}},rivets.components.scenario_component={template:function(){return document.querySelector("#scenario_component").innerHTML},initialize:function(e,t){t.depth++;var n=t.scenario.get("components").findWhere({component_id:t.component.id});return t.scenario_component=n||t.scenario.get("components").findWhere({component_cid:t.component.cid}),t.scenario_component=n||t.scenario.addComponent(t.component),t}},rivets.binders["input-match"]={publishes:!0,priority:2e3,bind:function(e){this.event="change",rivets._.Util.bindEvent(e,this.event,this.publish)},unbind:function(){rivets.binders.value.unbind.apply(this,arguments)},routine:function(){rivets.binders.value.routine.apply(this,arguments)}},e("body").on("click",".js-component-list a",function(t){e(this).closest(".js-component-list").find("a").removeClass("current"),e(this).addClass("current"),e(this).closest(".js-component").find(".js-component-page").addClass("hide");var n=e(this).data("tab");e(this).closest(".js-component").find(".js-component-page-"+n).removeClass("hide"),t.preventDefault()}),setTimeout(s,0),rivets.bind(c,{product:x})});